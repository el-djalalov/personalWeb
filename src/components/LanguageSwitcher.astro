---
import { LANGUAGE_NAMES, SUPPORTED_LANGUAGES, type Language } from "@/content.config";
import { getLangFromUrl } from "@/i18n";

const currentLang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;
---

<div class="relative" id="lang-switcher-container">
  <button
    id="lang-switcher-btn"
    class="flex items-center gap-1.5 px-2 py-1.5 text-xs font-medium rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
    aria-label="Select language"
    aria-expanded="false"
  >
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
    </svg>
    <span class="hidden sm:inline">{LANGUAGE_NAMES[currentLang]}</span>
    <span class="sm:hidden">{currentLang.toUpperCase()}</span>
    <svg class="w-3 h-3 transition-transform" id="lang-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <div
    id="lang-dropdown"
    class="absolute right-0 top-full mt-1 py-1 min-w-[120px] rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-lg opacity-0 invisible transition-all duration-200 z-50"
  >
    {SUPPORTED_LANGUAGES.map((lang) => {
      const isActive = lang === currentLang;
      // Build URL with language parameter
      const langUrl = lang === "en"
        ? currentPath
        : `${currentPath}${currentPath.includes("?") ? "&" : "?"}lang=${lang}`;

      return (
        <a
          href={langUrl}
          class:list={[
            "flex items-center gap-2 px-3 py-2 text-sm transition-colors",
            isActive
              ? "bg-violet-50 dark:bg-violet-900/30 text-violet-700 dark:text-violet-300"
              : "text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800",
          ]}
          data-lang={lang}
        >
          <span class="w-5 text-center">{isActive ? "âœ“" : ""}</span>
          {LANGUAGE_NAMES[lang]}
        </a>
      );
    })}
  </div>
</div>

<script is:inline>
  function initLangSwitcher() {
    const btn = document.getElementById("lang-switcher-btn");
    const dropdown = document.getElementById("lang-dropdown");
    const chevron = document.getElementById("lang-chevron");

    if (!btn || !dropdown || !chevron) return;

    let isOpen = false;

    function toggle() {
      isOpen = !isOpen;
      btn.setAttribute("aria-expanded", isOpen.toString());

      if (isOpen) {
        dropdown.classList.remove("opacity-0", "invisible");
        dropdown.classList.add("opacity-100", "visible");
        chevron.classList.add("rotate-180");
      } else {
        dropdown.classList.add("opacity-0", "invisible");
        dropdown.classList.remove("opacity-100", "visible");
        chevron.classList.remove("rotate-180");
      }
    }

    function close() {
      if (isOpen) {
        isOpen = false;
        btn.setAttribute("aria-expanded", "false");
        dropdown.classList.add("opacity-0", "invisible");
        dropdown.classList.remove("opacity-100", "visible");
        chevron.classList.remove("rotate-180");
      }
    }

    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggle();
    });

    document.addEventListener("click", (e) => {
      if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
        close();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        close();
      }
    });
  }

  // Initialize on page load
  initLangSwitcher();

  // Re-initialize after Astro page transitions
  document.addEventListener("astro:after-swap", initLangSwitcher);
</script>
