---
export const prerender = true;
import BaseLayout from "@/layouts/BaseLayout.astro";
import BlogCard from "@/components/blog/BlogCard.astro";
import { getCollection } from "astro:content";
import readingTime from "reading-time";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const allTags = [...new Set(posts.flatMap(post => post.data.tags))].filter(
    tag => tag && tag.trim() !== "",
  );

  return allTags.map(tag => ({
    params: { tag: tag.toLowerCase() },
    props: {
      tag,
      posts: posts
        .filter(
          post =>
            !post.data.draft &&
            post.data.tags
              .map(t => t.toLowerCase())
              .includes(tag.toLowerCase()),
        )
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

const { tag, posts } = Astro.props;

// Handle case where props might be undefined (SSR mode)
if (!tag || !posts) {
  return Astro.redirect("/blog");
}

// Get all unique tags for filter
const allPosts = await getCollection("blog");
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))]
  .filter(tag => tag && tag.trim() !== "")
  .sort();

function getReadingTime(body: string): string {
  const stats = readingTime(body);
  return stats.text;
}
---

<BaseLayout
  title={`${tag} - Blog | Elyor Djalalov`}
  description={`Articles tagged with ${tag} by Elyor Djalalov.`}
>
  <main class="max-w-6xl mx-auto px-4 py-8 pt-20">
    <!-- Header -->
    <header class="mb-12 text-center">
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400 hover:text-violet-600 dark:hover:text-violet-400 transition-colors mb-4 group"
      >
        <svg
          class="w-4 h-4 transition-transform group-hover:-translate-x-1"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
        All Posts
      </a>
      <h1
        class="text-4xl md:text-5xl font-bold text-slate-900 dark:text-white mb-4"
      >
        <span class="text-violet-600 dark:text-violet-400">#{tag}</span>
      </h1>
      <p class="text-lg text-slate-600 dark:text-slate-400">
        {posts.length}
        {posts.length === 1 ? "post" : "posts"} tagged with <span
          class="font-medium">{tag}</span
        >
      </p>
    </header>

    <!-- Tags filter -->
    <div class="mb-8">
      <div class="flex flex-wrap justify-center gap-2">
        <a
          href="/blog"
          class="px-4 py-2 text-sm font-medium rounded-full bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-violet-100 dark:hover:bg-violet-900/30 hover:text-violet-700 dark:hover:text-violet-300 transition-colors"
        >
          All Posts
        </a>
        {
          allTags.map(t => (
            <a
              href={`/blog/tag/${t.toLowerCase()}`}
              class:list={[
                "px-4 py-2 text-sm font-medium rounded-full transition-colors",
                t.toLowerCase() === tag.toLowerCase()
                  ? "bg-violet-600 text-white"
                  : "bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-violet-100 dark:hover:bg-violet-900/30 hover:text-violet-700 dark:hover:text-violet-300",
              ]}
            >
              #{t}
            </a>
          ))
        }
      </div>
    </div>

    <!-- Posts grid -->
    {
      posts.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {posts.map(post => (
            <BlogCard
              post={post}
              readingTime={getReadingTime(post.body || "")}
            />
          ))}
        </div>
      ) : (
        <div class="text-center py-20">
          <p class="text-slate-500 dark:text-slate-400">
            No posts found with this tag.
          </p>
        </div>
      )
    }
  </main>
</BaseLayout>
